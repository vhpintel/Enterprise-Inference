# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
- name: Create Kubernetes Job for model registration
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: "register-{{ reg_model_name | replace('/', '-') | replace('.', '-') | lower }}"
        namespace: default
      spec:
        ttlSecondsAfterFinished: 300
        backoffLimit: 3
        template:
          metadata:
            name: model-registration
          spec:
            restartPolicy: Never
            containers:
            - name: register-model
              image: curlimages/curl:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -e
                  
                  # Check if model already exists
                  RESPONSE=$(curl -s -w "\n%{http_code}" \
                    -H "accept: application/json" \
                    -H "Authorization: Bearer {{ litellm_master_key }}" \
                    "http://genai-gateway-service.genai-gateway.svc.cluster.local:4000/models?return_wildcard_routes=false")
                  
                  HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                  BODY=$(echo "$RESPONSE" | sed '$d')
                  
                  if [ "$HTTP_CODE" = "200" ]; then
                    MODEL_EXISTS=$(echo "$BODY" | grep -o '"id":"{{ reg_model_name }}"' || echo "")
                    if [ -n "$MODEL_EXISTS" ]; then
                      echo "Model {{ reg_model_name }} already exists, skipping registration"
                      exit 0
                    fi
                  fi
                  
                  # Register the model
                  REGISTER_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                    -H "accept: */*" \
                    -H "cache-control: no-cache" \
                    -H "content-type: application/json" \
                    -H "Authorization: Bearer {{ litellm_master_key }}" \
                    -d '{
                      "model_name": "{{ reg_model_name }}",
                      "litellm_params": {
                        "model": "{{ reg_litellm_model }}",
                        "custom_llm_provider": "{{ reg_custom_llm_provider }}",
                        "api_key": "none",
                        "api_base": "{{ reg_api_base }}",
                        "input_cost_per_token": {{ reg_input_cost_per_token }},
                        "output_cost_per_token": {{ reg_output_cost_per_token }}
                      },
                      "model_info": {
                        "mode": "{{ reg_model_mode | default('chat') }}"
                      }
                    }' \
                    "http://genai-gateway-service.genai-gateway.svc.cluster.local:4000/model/new")
                  
                  REGISTER_HTTP_CODE=$(echo "$REGISTER_RESPONSE" | tail -n1)
                  REGISTER_BODY=$(echo "$REGISTER_RESPONSE" | sed '$d')
                  
                  if [ "$REGISTER_HTTP_CODE" != "200" ]; then
                    echo "ERROR: Model registration failed with HTTP code $REGISTER_HTTP_CODE"
                    echo "$REGISTER_BODY"
                    exit 1
                  fi
                  
                  echo "Model {{ reg_model_name }} registered successfully"
            tolerations:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
                effect: NoSchedule
              - key: node-role.kubernetes.io/master
                operator: Exists
                effect: NoSchedule
  run_once: true
  tags: always

- name: Wait for model registration Job to complete
  kubernetes.core.k8s_info:
    kind: Job
    namespace: default
    name: "register-{{ reg_model_name | replace('/', '-') | replace('.', '-') | lower }}"
  register: registration_job
  until: >
    (registration_job.resources[0].status.succeeded is defined and
    registration_job.resources[0].status.succeeded == 1) or
    (registration_job.resources[0].status.failed is defined and
    registration_job.resources[0].status.failed >= 3)
  retries: 30
  delay: 10
  run_once: true
  tags: always

- name: Get model registration Job logs
  command: kubectl logs job/register-{{ reg_model_name | replace('/', '-') | replace('.', '-') | lower }} -n default
  register: registration_output
  run_once: true
  tags: always

- name: Display model registration result
  debug:
    msg: "{{ registration_output.stdout_lines }}"
  run_once: true
  tags: always
