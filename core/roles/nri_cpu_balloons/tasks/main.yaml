# Copyright (C) 2025-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---
# ============================================================================
# Platform Detection - Use kubernetes_platform from brownfield deployment
# ============================================================================
- name: Display platform information
  ansible.builtin.debug:
    msg:
      - "==================================================================="
      - "Platform Configuration"
      - "==================================================================="
      - "Kubernetes Platform: {{ kubernetes_platform | default('UNDEFINED - THIS IS A PROBLEM!') }}"
      - "OpenShift Deployment: {{ (kubernetes_platform | default('')) == 'openshift' }}"
      - "==================================================================="
  tags:
    - install

# ============================================================================
# Default Configuration
# ============================================================================

- name: Auto-compute nri_reserved_cpu_list if not provided
  ansible.builtin.include_role:
    name: utils
    tasks_from: get_optimized_cpu_topology
  when:
    - nri_reserved_cpu_list is not defined or (nri_reserved_cpu_list | string | length) == 0

- name: Debug normalized nri_reserved_cpu_list
  ansible.builtin.debug:
    msg: "nri_reserved_cpu_list={{ nri_reserved_cpu_list }}"

- name: Validate nri_reserved_cpu_list
  ansible.builtin.assert:
    that:
      - nri_reserved_cpu_list is defined
      - (nri_reserved_cpu_list | regex_search('^[0-9]+([,-][0-9]+)*$')) is not none
    fail_msg: "nri_reserved_cpu_list is missing or malformed. Expected cpuset syntax like '0,1,32,33'."

- name: Set default NRI CPU balloons configuration if not defined
  ansible.builtin.set_fact:
    nri_cpu_balloons:
      enabled: true
      namespace: "kube-system"
      auto_install: true
      installation_timeout: 300
      helm:
        repo_url: "https://containers.github.io/nri-plugins"
        repo_name: "nri-plugins"
        chart_name: "nri-resource-policy-balloons"
        release_name: "nri-cpu-balloons"
  when: nri_cpu_balloons is not defined
  tags:
    - install

- name: Set default generic balloon configuration if not defined
  ansible.builtin.set_fact:
    generic_balloon:
      name: "vllm-balloon"
      match_expression: "name=vllm"
      policy_settings:
        preferIsolCpus: false
        preferNewBalloons: true
        hideHyperthreads: true
  when: generic_balloon is not defined
  tags:
    - install

- name: Check if this is a CPU deployment
  ansible.builtin.fail:
    msg: "This role should only be used for CPU deployments. Set cpu_playbook=true"
  when: cpu_playbook != 'true'
  tags:
    - install

- name: Display generic balloon deployment info
  ansible.builtin.debug:
    msg:
      - "==================================================================="
      - "Generic NRI Balloon Policy Creation"
      - "==================================================================="
      - "Creating single generic balloon policy for all models"
      - "Balloon Name: {{ generic_balloon.name }}"
      - "Match Expression: {{ generic_balloon.match_expression }}"
      - "==================================================================="
  tags:
    - install

- name: Check if existing balloon policy exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: "nri-resource-policy-balloons-config"
    namespace: "{{ nri_cpu_balloons.namespace }}"
  register: existing_balloon_config
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  tags:
    - install

- name: Parse existing balloon configuration
  ansible.builtin.set_fact:
    existing_config: "{{ (existing_balloon_config.resources[0].data['values.yaml'] | from_yaml) if existing_balloon_config.resources | length > 0 else {} }}"
  tags:
    - install

- name: Check if generic vllm balloon already exists
  ansible.builtin.set_fact:
    vllm_balloon_exists: >-
      {{
        existing_config.config.balloonTypes | default([])
        | selectattr('name', 'equalto', generic_balloon.name)
        | list | length > 0
      }}
  tags:
    - install

- name: Get existing balloon configuration if it exists
  ansible.builtin.set_fact:
    existing_balloon_config: >-
      {{
        (existing_config.config.balloonTypes | default([])
        | selectattr('name', 'equalto', generic_balloon.name)
        | list | first) if vllm_balloon_exists else {}
      }}
  tags:
    - install

- name: Check if existing balloon configuration needs update
  ansible.builtin.set_fact:
    balloon_needs_update: >-
      {{
        vllm_balloon_exists and (
          existing_balloon_config.get('allocatorPriority') != 'high' or
          existing_balloon_config.get('allocatorTopologyBalancing') != true or
          existing_balloon_config.get('preferSpreadOnNuma') is defined or
          existing_balloon_config.get('preserveCpus') is defined or
          existing_balloon_config.get('allocatorPriority', '') == '0' or
          existing_balloon_config.get('allocatorPriority', '') | type_debug == 'int' or
          existing_config.config.get('preserve') is not defined or
          existing_config.config.get('pinMemory', true) != false
        )
      }}
  tags:
    - install

- name: Display existing balloon status
  ansible.builtin.debug:
    msg:
      - "==================================================================="
      - "Existing Balloon Policy Status"
      - "==================================================================="
      - "Configuration exists: {{ 'YES' if existing_config != {} else 'NO' }}"
      - "Generic vLLM balloon exists: {{ 'YES' if vllm_balloon_exists else 'NO' }}"
      - "Balloon configuration needs update: {{ 'YES' if balloon_needs_update | default(false) else 'NO' }}"
      - "{{ 'Reason: Outdated configuration detected (old fields or wrong priority)' if balloon_needs_update | default(false) else '' }}"
      - "{{ 'Proceeding with balloon update/creation' if (not vllm_balloon_exists or balloon_needs_update | default(false)) else 'Skipping - balloon already properly configured' }}"
      - "==================================================================="
  tags:
    - install

- name: Set NRI installation task file based on platform
  ansible.builtin.set_fact:
    nri_install_file: "{{ 'install_nri_openshift.yaml' if kubernetes_platform == 'openshift' else 'install_nri.yaml' }}"
  tags:
    - install

- name: Install NRI if not present and balloon doesn't exist or needs update
  ansible.builtin.include_tasks: "{{ nri_install_file }}"
  when:
    - not vllm_balloon_exists or balloon_needs_update | default(false)
    - not nri_supported | default(false)
    - nri_cpu_balloons.auto_install | default(true)
  tags:
    - install

- name: Check if reserved balloon exists
  ansible.builtin.set_fact:
    reserved_balloon_exists: >-
      {{
        existing_config.config.balloonTypes | default([])
        | selectattr('name', 'equalto', 'reserved')
        | list | length > 0
      }}
  when: vllm_balloon_exists
  tags:
    - install

- name: Check if existing config matches simplified balloon structure
  ansible.builtin.set_fact:
    balloon_needs_update: >-
      {{
        vllm_balloon_exists and (
          not reserved_balloon_exists | default(false) or
          existing_balloon_config.get('allocatorPriority') != 'high' or
          existing_config.config.get('agent', {}).get('nodeResourceTopology') != true or
          existing_config.config.get('agent', {}).get('podResourceAPI') != false or
          existing_config.config.get('pinCPU') != true or
          existing_config.config.get('pinMemory') != false or
          existing_config.config.get('allocatorTopologyBalancing') != true or
          existing_balloon_config.get('preferSpreadOnNuma') is defined or
          existing_balloon_config.get('preserveCpus') is defined or
          existing_balloon_config.get('preferSpreadOnPhysicalCores') is defined or
          existing_balloon_config.get('preferIsolCpus') is defined or
          existing_balloon_config.get('preferNewBalloons') is defined or
          existing_balloon_config.get('hideHyperthreads') is defined or
          existing_balloon_config.get('pinCpus') is defined or
          existing_balloon_config.get('pinMemory') is defined or
          existing_balloon_config.get('namespaces') is defined
        )
      }}
  when: vllm_balloon_exists
  tags:
    - install

- name: Debug simplified balloon validation
  ansible.builtin.debug:
    msg:
      - "==================================================================="
      - "Simplified Balloon Configuration Validation"
      - "==================================================================="
      - "Required Balloons:"
      - "  vllm-balloon exists: {{ 'YES' if vllm_balloon_exists else 'NO' }}"
      - "  reserved balloon exists: {{ 'YES' if reserved_balloon_exists | default(false) else 'NO' }}"
      - ""
      - "Required Global Settings:"
      - "  agent.nodeResourceTopology: {{ existing_config.config.get('agent', {}).get('nodeResourceTopology', 'NOT_SET') }} (need: true)"
      - "  agent.podResourceAPI: {{ existing_config.config.get('agent', {}).get('podResourceAPI', 'NOT_SET') }} (need: false)"
      - "  pinCPU: {{ existing_config.config.get('pinCPU', 'NOT_SET') }} (need: true)"
      - "  pinMemory: {{ existing_config.config.get('pinMemory', 'NOT_SET') }} (need: false)"
      - "  allocatorTopologyBalancing: {{ existing_config.config.get('allocatorTopologyBalancing', 'NOT_SET') }} (need: true)"
      - ""
      - "vllm-balloon Settings:"
      - "  allocatorPriority: {{ existing_balloon_config.get('allocatorPriority', 'NOT_SET') }} (need: high)"
      - ""
      - "OLD per-balloon fields detected (should NOT exist):"
      - "  preferSpreadOnNuma: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('preferSpreadOnNuma') is defined else 'NO (OK)' }}"
      - "  preserveCpus: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('preserveCpus') is defined else 'NO (OK)' }}"
      - "  preferSpreadOnPhysicalCores: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('preferSpreadOnPhysicalCores') is defined else 'NO (OK)' }}"
      - "  preferIsolCpus: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('preferIsolCpus') is defined else 'NO (OK)' }}"
      - "  preferNewBalloons: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('preferNewBalloons') is defined else 'NO (OK)' }}"
      - "  hideHyperthreads: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('hideHyperthreads') is defined else 'NO (OK)' }}"
      - "  pinCpus: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('pinCpus') is defined else 'NO (OK)' }}"
      - "  pinMemory: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('pinMemory') is defined else 'NO (OK)' }}"
      - "  namespaces: {{ 'YES (NEEDS UPDATE)' if existing_balloon_config.get('namespaces') is defined else 'NO (OK)' }}"
      - ""
      - "Update needed: {{ 'YES' if balloon_needs_update | default(false) else 'NO' }}"
      - "==================================================================="
  when: vllm_balloon_exists
  tags:
    - install

- name: Ensure temporary directory exists
  ansible.builtin.file:
    path: "{{ tmp_dir }}"
    state: directory
    mode: "0755"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Create generic balloon values file
  ansible.builtin.template:
    src: "generic-balloon-values.yaml.j2"
    dest: "{{ tmp_dir }}/generic-balloon-values.yaml"
    mode: "0644"
  vars:
    balloon_name: "{{ generic_balloon.name }}"
    match_expression: "{{ generic_balloon.match_expression }}"
    prefer_isol_cpus: "{{ generic_balloon.policy_settings.preferIsolCpus }}"
    prefer_new_balloons: "{{ generic_balloon.policy_settings.preferNewBalloons }}"
    hide_hyperthreads: "{{ generic_balloon.policy_settings.hideHyperthreads }}"
    prometheus_enabled: "{{ enable_prometheus | default('false') }}"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Ensure NRI plugins Helm repository is available
  kubernetes.core.helm_repository:
    name: "{{ nri_cpu_balloons.helm.repo_name }}"
    repo_url: "{{ nri_cpu_balloons.helm.repo_url }}"
    state: present
  environment:
    HTTP_PROXY: "{{ http_proxy | default(ansible_env.HTTP_PROXY | default('')) }}"
    HTTPS_PROXY: "{{ https_proxy | default(ansible_env.HTTPS_PROXY | default('')) }}"
    NO_PROXY: "{{ no_proxy | default(ansible_env.NO_PROXY | default('')) }}"
  retries: 3
  delay: 10
  register: helm_repo_result
  until: helm_repo_result is succeeded
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Load generic balloon configuration
  ansible.builtin.slurp:
    src: "{{ tmp_dir }}/generic-balloon-values.yaml"
  register: balloon_config_content
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Parse generic balloon configuration
  ansible.builtin.set_fact:
    new_balloon_config: "{{ balloon_config_content.content | b64decode | from_yaml }}"
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Debug decision state before applying template configuration
  ansible.builtin.debug:
    msg:
      - "existing_config_empty={{ existing_config == {} }}"
      - "existing_config_keys={{ existing_config.keys() | default([]) }}"
      - "vllm_balloon_exists={{ vllm_balloon_exists }}"
      - "balloon_needs_update={{ balloon_needs_update | default(false) }}"
      - "nri_reserved_cpu_list={{ nri_reserved_cpu_list }}"
      - "enable_prometheus={{ enable_prometheus | default(false) }}"
      - "Using simplified balloon policy from template"
  tags:
    - install


- name: Use complete template configuration directly
  ansible.builtin.set_fact:
    updated_config: "{{ new_balloon_config }}"
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Deploy/Update generic balloon policy ConfigMap
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "nri-resource-policy-balloons-config"
        namespace: "{{ nri_cpu_balloons.namespace }}"
        labels:
          app.kubernetes.io/name: nri-resource-policy-balloons
      data:
        "values.yaml": "{{ updated_config | to_nice_yaml }}"
    state: present
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Create temporary values file for NRI deployment
  ansible.builtin.copy:
    content: "{{ updated_config | to_nice_yaml }}"
    dest: "{{ tmp_dir }}/nri-values.yaml"
    mode: "0644"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Deploy/Update NRI resource policy with generic balloon
  ansible.builtin.command: >
    helm upgrade --install nri-resource-policy-balloons
    {{ nri_cpu_balloons.helm.repo_name }}/{{ nri_cpu_balloons.helm.chart_name }}
    --namespace {{ nri_cpu_balloons.namespace }}
    --values {{ tmp_dir }}/nri-values.yaml
    {{ '--force' if balloon_needs_update | default(false) else '' }}
  environment:
    HTTP_PROXY: "{{ http_proxy | default(ansible_env.HTTP_PROXY | default('')) }}"
    HTTPS_PROXY: "{{ https_proxy | default(ansible_env.HTTPS_PROXY | default('')) }}"
    NO_PROXY: "{{ no_proxy | default(ansible_env.NO_PROXY | default('')) }}"
  register: helm_result
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Wait for DaemonSet to exist before patching (OpenShift only)
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    name: nri-resource-policy-balloons
    namespace: "{{ nri_cpu_balloons.namespace }}"
  register: ds_check
  until: ds_check.resources | length > 0
  retries: 10
  delay: 3
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when:
    - kubernetes_platform == 'openshift'
  tags:
    - install

- name: Apply OpenShift security context patch to NRI DaemonSet
  ansible.builtin.shell: |
    kubectl patch daemonset nri-resource-policy-balloons -n {{ nri_cpu_balloons.namespace }} --type strategic --patch '
    spec:
      template:
        spec:
          hostPID: true
          hostNetwork: true
          securityContext:
            seLinuxOptions:
              type: spc_t
          containers:
          - name: nri-resource-policy-balloons
            securityContext:
              privileged: false
              allowPrivilegeEscalation: true
              runAsUser: 0
              runAsGroup: 0
              seLinuxOptions:
                type: spc_t
              capabilities:
                add:
                - NET_ADMIN
                - SYS_ADMIN
                - SYS_PTRACE
                - SYS_RESOURCE
                - DAC_OVERRIDE
                drop: []
    '
  register: security_patch_result
  until: security_patch_result.rc == 0
  retries: 3
  delay: 5
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  failed_when: security_patch_result.rc != 0
  when:
    - kubernetes_platform == 'openshift'
  tags:
    - install

- name: Verify security context patch applied (OpenShift only)
  ansible.builtin.shell: |
    kubectl get daemonset nri-resource-policy-balloons -n {{ nri_cpu_balloons.namespace }} \
      -o jsonpath='{.spec.template.spec.containers[0].securityContext.capabilities.add}'
  register: verify_patch
  until: "'SYS_ADMIN' in verify_patch.stdout"
  retries: 5
  delay: 3
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when:
    - kubernetes_platform == 'openshift'
  tags:
    - install

- name: Force restart all NRI pods after security context patch (OpenShift only)
  ansible.builtin.shell: |
    kubectl -n {{ nri_cpu_balloons.namespace }} delete pods \
      -l app.kubernetes.io/name=nri-resource-policy-balloons \
      --grace-period=0 --force
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when:
    - kubernetes_platform == 'openshift'
  tags:
    - install

- name: Wait for pods to be recreated (OpenShift only)
  ansible.builtin.pause:
    seconds: 15
    prompt: "Waiting for NRI pods to be recreated with correct security context..."
  run_once: true
  when:
    - not vllm_balloon_exists or balloon_needs_update | default(false)
    - kubernetes_platform == 'openshift'
  tags:
    - install

- name: Verify NRI balloon daemonset is ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    name: "nri-resource-policy-balloons"
    namespace: "{{ nri_cpu_balloons.namespace }}"
  register: nri_daemonset_status
  failed_when:
    - nri_daemonset_status.resources | length == 0
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install

- name: Export balloon configuration for model deployments
  ansible.builtin.set_stats:
    data:
      # Generic balloon annotation for all model pods
      cpu_balloon_annotation:
        "balloon.balloons.resource-policy.nri.io": "{{ generic_balloon.name }}"

      # Parallelism configuration
      model_parallelism_config:
        tensor_parallel_size: "{{ parallelism_config.tensor_parallel_size | default(1) }}"
        pipeline_parallel_size: "{{ parallelism_config.pipeline_parallel_size | default(1) }}"
        strategy: "{{ parallelism_config.strategy | default('tensor_parallel') }}"
    aggregate: false
  tags:
    - install

- name: Display final deployment status
  ansible.builtin.debug:
    msg:
      - "==================================================================="
      - "Generic NRI Balloon Policy Deployment Complete"
      - "==================================================================="
      - >-
        {%- if not vllm_balloon_exists -%}
        New generic balloon policy created successfully
        {%- elif balloon_needs_update | default(false) -%}
        Balloon policy updated successfully (fixed outdated configuration)
        {%- else -%}
        Balloon policy already existed - no changes made
        {%- endif -%}
      - ""
      - "Balloon Configuration:"
      - "  Name: {{ generic_balloon.name }}"
      - "  Match Expression: {{ generic_balloon.match_expression }}"
      - "  CPU Pinning: Enabled"
      - "  Memory Pinning: Disabled"
      - ""
      - "Model Deployment Instructions:"
      - "  Add this annotation to model pods:"
      - "  balloon.balloons.resource-policy.nri.io: {{ generic_balloon.name }}"
      - ""
      - "  All models matching 'name=vllm' will automatically use this balloon"
      - "==================================================================="
  tags:
    - install

- name: Clean up temporary files
  ansible.builtin.file:
    path: "{{ tmp_dir }}"
    state: absent
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  run_once: true
  when: not vllm_balloon_exists or balloon_needs_update | default(false)
  tags:
    - install
