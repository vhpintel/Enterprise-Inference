# Copyright (C) 2024-2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
{{- if .Values.apisix.enabled }}
apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: {{ include "tgi.fullname" . }}-apisixroute
  namespace: default
spec:
  http:
  - name: {{ include "tgi.fullname" . }}-apisixroute
    match:
      hosts:
      - {{ .Values.route.host | default .Values.ingress.host }}
      paths:
      # - /{{ .Values.LLM_MODEL_ID | splitList "/" | last }}/*
      {{- if not .Values.accelDevice }}
      - /{{ .Values.LLM_MODEL_ID | splitList "/" | last }}-tgicpu/*
      {{- else }}
      - /{{ .Values.LLM_MODEL_ID | splitList "/" | last }}/*
      {{- end }}
    backends:
    - serviceName: {{ include "tgi.fullname" . }}-service
      servicePort: {{- if .Values.route.enabled }}
                     tgi
                   {{- else }}
                     80
                   {{- end }}
    plugins:
    - name: openid-connect
      enable: true
      secretRef: {{ include "tgi.fullname" . }}-secret
      config:
        discovery: {{ .Values.oidc.discovery }}
        {{- if eq .Values.platform "openshift" }}
        use_jwks: {{ .Values.oidc.use_jwks }}
        {{- else }}
        introspection_endpoint: {{ .Values.oidc.introspection_endpoint }}
        introspection_endpoint_auth_method: client_secret_basic
        {{- end }}
        scope: openid profile email
        bearer_only: true
        realm: master
    - name: proxy-rewrite
      enable: true
      config:
        regex_uri:
          {{- if not .Values.accelDevice }}
          - ^/{{ .Values.LLM_MODEL_ID | splitList "/" | last }}-tgicpu/(.*)
          {{- else }}
          - ^/{{ .Values.LLM_MODEL_ID | splitList "/" | last }}/(.*)
          {{- end }}
          - /$1
          # - ^/{{ .Values.LLM_MODEL_ID | splitList "/" | last }}/(.*)
          # - /$1
        headers:
          Content-Type: application/json
{{- end }}